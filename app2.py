import numpy as np
import math

# ================================
# 상수
# ================================
k = math.sqrt(2.8 / math.pi)

# ================================
# 전체 실험 데이터 (생략 없음)
# 컬럼 순서:
# [X2, Y2, X, Y, r]
# ================================
DATA = np.array([
    [9.7112,10.5629,6.4478,7.8077,6.666666667],
    [10.1416,10.7106,6.5861,7.8507,6.666666667],
    [9.0265,9.8080,6.3613,7.7335,6.666666667],
    [9.6762,10.4004,6.5818,7.9927,4],
    [10.0628,10.5502,6.7735,8.0119,4],
    [9.3416,10.1726,6.4607,8.0073,4],
    [8.7779,9.4212,6.6476,7.7594,2.857142857],
    [9.0259,9.9314,6.3172,8.0195,2.857142857],
    [8.8532,10.0700,6.3760,8.1712,2.857142857],
    [7.7421,8.3406,6.5059,7.8457,2.222222222],
    [8.1121,9.0585,6.6817,8.1295,2.222222222],
    [8.2743,8.7186,6.7386,7.7591,2.222222222],
    [7.9013,8.5012,6.8793,8.0136,1.818181818],
    [7.9775,8.3824,6.7011,7.9435,1.818181818],
    [7.0939,8.1968,6.5405,7.8954,1.818181818],

    [9.6276,10.8291,5.9684,8.2477,6.666666667],
    [10.0190,11.0795,6.4412,8.1748,6.666666667],
    [9.8988,10.6498,5.9558,8.4775,6.666666667],
    [9.0938,10.3500,5.9963,8.4121,4],
    [9.5110,10.5657,6.2848,8.3945,4],
    [8.8117,10.2971,5.8145,8.3730,4],
    [7.8961,9.6112,5.9405,8.5892,2.857142857],
    [8.4365,9.9420,6.2844,8.5892,2.857142857],
    [7.8009,9.7138,6.0442,8.4650,2.857142857],
    [6.9587,8.8864,5.9747,8.4111,2.222222222],
    [7.5535,9.1442,6.2317,8.4596,2.222222222],
    [7.4706,8.9177,6.2320,8.2910,2.222222222],
    [6.6218,8.7828,6.1015,8.2919,1.818181818],
    [6.9184,9.1117,6.0109,8.6156,1.818181818],
    [6.5968,8.6357,6.1230,8.3862,1.818181818],

    [10.1665,12.2168,5.6251,9.0403,6.666666667],
    [10.2180,12.1021,5.8999,9.1426,6.666666667],
    [9.3675,11.3178,5.6751,9.1371,6.666666667],
    [9.0581,11.2648,5.5292,9.0185,4],
    [9.0581,11.3532,5.6236,9.2803,4],
    [8.9339,10.7240,5.4110,9.1981,4],
    [8.3460,10.7077,5.6717,9.0772,2.857142857],
    [8.6700,10.9495,5.7797,9.2003,2.857142857],
    [8.6798,10.8898,5.7994,9.2964,2.857142857],
    [7.0410,9.8444,5.6957,9.0696,2.222222222],
    [7.5574,10.1758,5.8538,9.2546,2.222222222],
    [7.1486,10.0866,5.7569,9.2204,2.222222222],
    [6.3332,9.6841,5.5597,9.1693,1.818181818],
    [6.6919,9.8089,5.5235,9.1470,1.818181818],
    [6.6472,9.6683,5.7275,9.0671,1.818181818],

    [9.1531,11.9211,5.3257,9.5674,6.666666667],
    [9.2287,12.1374,5.3619,9.6178,6.666666667],
    [9.3166,11.8793,5.5979,9.8471,6.666666667],
    [8.8740,11.5386,5.4784,9.5217,4],
    [9.3611,12.0671,5.4892,9.6073,4],
    [9.3726,11.9725,5.5763,9.7530,4],
    [7.8920,10.7730,5.4415,9.6956,2.857142857],
    [8.0916,11.5033,5.3967,9.8726,2.857142857],
    [7.9558,11.0224,5.4557,9.6855,2.857142857],
    [7.1183,10.5515,5.3108,9.5881,2.222222222],
    [7.5561,10.7936,5.4949,9.7124,2.222222222],
    [7.9017,10.5257,5.6268,9.5242,2.222222222],
    [6.3397,11.0664,5.4503,9.5514,1.818181818],
    [6.8005,10.3182,5.5985,9.4027,1.818181818],
    [7.1422,9.8513,5.6181,9.3778,1.818181818],

    [8.9331,12.6064,5.0770,5.0770,6.666666667],
    [9.0012,12.6574,5.2861,5.2861,6.666666667],
    [9.6132,11.6129,5.0727,5.0727,6.666666667],
    [9.2156,12.3872,5.1295,5.1295,4],
    [9.0976,12.4201,5.3300,5.3300,4],
    [8.1345,11.6063,5.0113,5.0113,4],
    [7.5697,11.3859,5.0559,5.0559,2.857142857],
    [8.0523,11.5784,5.2514,5.2514,2.857142857],
    [7.1599,10.9951,5.1761,5.1761,2.857142857],
    [6.7803,10.9656,5.1501,5.1501,2.222222222],
    [7.2194,11.2226,5.1488,5.1488,2.222222222],
    [6.5963,10.8731,4.9842,4.9842,2.222222222],
    [6.0998,10.6048,5.1103,5.1103,1.818181818],
    [5.9987,10.4691,5.0697,5.0697,1.818181818],
    [5.5649,10.2692,5.1413,5.1413,1.818181818],
])

# ================================
# 파라미터 학습
# ================================
def _fit_params():
    X2 = DATA[:, 0]
    Y2 = DATA[:, 1]
    X  = DATA[:, 2]
    Y  = DATA[:, 3]
    r  = DATA[:, 4]

    M = np.column_stack([
        k * X2,
        k * X2 * r,
        k * Y2,
        k * Y2 * r,
        np.ones_like(r),
        r
    ])

    theta_X, *_ = np.linalg.lstsq(M, X, rcond=None)
    theta_Y, *_ = np.linalg.lstsq(M, Y, rcond=None)

    return np.concatenate([theta_X, theta_Y])

# 한 번만 계산
PARAMS = _fit_params()

# ================================
# ✅ 최종 사용 함수
# ================================
def ellipse_xy(X2, Y2, r):
    """
    입력:
        X2 : 사각형 가로
        Y2 : 사각형 세로
        r  : 압축비
    출력:
        X, Y : 타원 단축 / 장축
    """
    p = PARAMS

    X = (
        p[0]*k*X2 +
        p[1]*k*X2*r +
        p[2]*k*Y2 +
        p[3]*k*Y2*r +
        p[4] +
        p[5]*r
    )

    Y = (
        p[6]*k*X2 +
        p[7]*k*X2*r +
        p[8]*k*Y2 +
        p[9]*k*Y2*r +
        p[10] +
        p[11]*r
    )

    return float(X), float(Y)
